<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Night Owl CLI Interface</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Fira Code', monospace;
      background-color: #011627;
      color: #d6deeb;
    }
    .terminal-wrapper {
      height: calc(100vh - 10px); /* Adjust based on your titlebar height and desired margins */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .terminal {
      width: 100%;
      max-width: 1100px; /* Adjust as needed */
      height: 80vh;
      border: 1px solid #1d3b53;
      overflow-y: auto;
      background-color: #011627;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
    }
    #input-container {
      background-color: #0b2942;
      max-width: 1100px; /* Increased to match the terminal width */
      width: 100%; /* Ensure it takes full width of its parent */
      margin: 20px auto 0;
      display: flex; /* Corrected typo from 'displayu' */
      padding: 10px; /* Added padding for better appearance */
    }
      #current-dir {
        color: #82aaff;
        white-space: nowrap; /* Prevent wrapping of directory path */
      }
    #input {
      background-color: transparent;
      color: #d6deeb;
      border: none;
      flex: 1; /* Changed from flex: 2 to take remaining space */
      margin-left: 10px; /* Add some space between directory and input */
    }
    .command-block {
      border: 1px solid #011627;
      border-radius: 4px;
      overflow: hidden;
    }
    .command {
      background-color: #0b2942;
      color: #c792ea;
    }
    .output {
      color: #d6deeb;
    }
    .error {
      color: #ef5350;
    }
    .titlebar {
      background: #011627;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #09416d;

    }
    .titlebar-buttons {
      padding: 0 10px;
      display: flex;
    }
    .titlebar-button, .custom-button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      margin-left: 5px;
      cursor: pointer;
    }
    .titlebar-button:hover, .custom-button:hover {
      background: #5bbec3;
    }
    .custom-button {
      color: #d6deeb;
      font-size: 14px;
      font-weight: bold;
    }
      #suggestions-container {
      background-color: #0b2942;
      color: #d6deeb;
      border-top: 1px solid #1d3b53;
      padding: 10px;
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      display: none; /* Hidden by default */
    }

    .suggestion {
      padding: 5px;
      cursor: pointer;
    }

    .suggestion:hover {
      background-color: #1d3b53;
    }
  </style>
</head>
<body>
  <div class="container-fluid vh-100 d-flex flex-column">
    <div data-tauri-drag-region class="titlebar">
      <div class="custom-buttons"> 
          <div class="custom-button" id="education">
             <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxLjJyZW0iIGhlaWdodD0iMS4ycmVtIiB2aWV3Qm94PSIwIDAgMjQgMjQiPjxnIGZpbGw9Im5vbmUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSIyIj48cGF0aCBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwIiBzdHJva2UtZGFzaGFycmF5PSI2NCIgc3Ryb2tlLWRhc2hvZmZzZXQ9IjY0IiBkPSJNMjIgM3YxNGMwIDAuNTUgLTAuNDUgMSAtMSAxaC0xNGMtMC41NSAwIC0xIC0wLjQ1IC0xIC0xdi0xNGMwIC0wLjU1IDAuNDUgLTEgMSAtMWgxNGMwLjU1IDAgMSAwLjQ1IDEgMVoiPjxhbmltYXRlIGZpbGw9ImZyZWV6ZSIgYXR0cmlidXRlTmFtZT0iZmlsbC1vcGFjaXR5IiBiZWdpbj0iMS45cyIgZHVyPSIwLjE1cyIgdmFsdWVzPSIwOzAuMyIvPjxhbmltYXRlIGZpbGw9ImZyZWV6ZSIgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hvZmZzZXQiIGR1cj0iMC42cyIgdmFsdWVzPSI2NDswIi8+PC9wYXRoPjxwYXRoIHN0cm9rZS1kYXNoYXJyYXk9IjEwIiBzdHJva2UtZGFzaG9mZnNldD0iMTAiIGQ9Ik0xMCA2aDgiPjxhbmltYXRlIGZpbGw9ImZyZWV6ZSIgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hvZmZzZXQiIGJlZ2luPSIwLjdzIiBkdXI9IjAuMnMiIHZhbHVlcz0iMTA7MCIvPjwvcGF0aD48cGF0aCBzdHJva2UtZGFzaGFycmF5PSIxMCIgc3Ryb2tlLWRhc2hvZmZzZXQ9IjEwIiBkPSJNMTAgMTBoOCI+PGFuaW1hdGUgZmlsbD0iZnJlZXplIiBhdHRyaWJ1dGVOYW1lPSJzdHJva2UtZGFzaG9mZnNldCIgYmVnaW49IjAuOXMiIGR1cj0iMC4ycyIgdmFsdWVzPSIxMDswIi8+PC9wYXRoPjxwYXRoIHN0cm9rZS1kYXNoYXJyYXk9IjYiIHN0cm9rZS1kYXNob2Zmc2V0PSI2IiBkPSJNMTAgMTRoNSI+PGFuaW1hdGUgZmlsbD0iZnJlZXplIiBhdHRyaWJ1dGVOYW1lPSJzdHJva2UtZGFzaG9mZnNldCIgYmVnaW49IjEuMXMiIGR1cj0iMC4ycyIgdmFsdWVzPSI2OzAiLz48L3BhdGg+PHBhdGggc3Ryb2tlLWRhc2hhcnJheT0iMzYiIHN0cm9rZS1kYXNob2Zmc2V0PSIzNiIgZD0iTTIgNnYxNWMwIDAuNTUgMC40NSAxIDEgMWgxNSI+PGFuaW1hdGUgZmlsbD0iZnJlZXplIiBhdHRyaWJ1dGVOYW1lPSJzdHJva2UtZGFzaG9mZnNldCIgYmVnaW49IjEuNHMiIGR1cj0iMC41cyIgdmFsdWVzPSIzNjswIi8+PC9wYXRoPjwvZz48L3N2Zz4=" alt="education" width="20" height="20">
          </div>
      </div>
      <div class="titlebar-buttons">
        <div class="titlebar-button" id="titlebar-minimize">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxLjJyZW0iIGhlaWdodD0iMS4ycmVtIiB2aWV3Qm94PSIwIDAgMjQgMjQiPjxwYXRoIGZpbGw9IndoaXRlIiBkPSJNNiAyMXYtMmgxMnYyeiIvPjwvc3ZnPg==" alt="minimize" width="20" height="20" color=white>
        </div>
        <div class="titlebar-button" id="titlebar-maximize">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxLjJyZW0iIGhlaWdodD0iMS4ycmVtIiB2aWV3Qm94PSIwIDAgMjQgMjQiPjxwYXRoIGZpbGw9IndoaXRlIiBkPSJNMjEgMkgzYTEgMSAwIDAgMC0xIDF2MThhMSAxIDAgMCAwIDEgMWgxOGExIDEgMCAwIDAgMS0xVjNhMSAxIDAgMCAwLTEtMW0tMSAxOEg0VjEwaDE2Wm0wLTEySDRWNGgxNloiLz48L3N2Zz4=" alt="maximize" width="20" height="20">
        </div>
        <div class="titlebar-button" id="titlebar-close">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxLjJyZW0iIGhlaWdodD0iMS4ycmVtIiB2aWV3Qm94PSIwIDAgNDggNDgiPjxkZWZzPjxtYXNrIGlkPSJpcFNDbG9zZU9uZTAiPjxnIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHN0cm9rZS13aWR0aD0iNCI+PHBhdGggZmlsbD0iI2ZmZiIgc3Ryb2tlPSIjZmZmIiBkPSJNMjQgNDRjMTEuMDQ2IDAgMjAtOC45NTQgMjAtMjBTMzUuMDQ2IDQgMjQgNFM0IDEyLjk1NCA0IDI0czguOTU0IDIwIDIwIDIwWiIvPjxwYXRoIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBkPSJNMjkuNjU3IDE4LjM0M0wxOC4zNDMgMjkuNjU3bTAtMTEuMzE0bDExLjMxNCAxMS4zMTQiLz48L2c+PC9tYXNrPjwvZGVmcz48cGF0aCBmaWxsPSJ3aGl0ZSIgZD0iTTAgMGg0OHY0OEgweiIgbWFzaz0idXJsKCNpcFNDbG9zZU9uZTApIi8+PC9zdmc+" alt="close" width="20" height="20">
        </div>
      </div>
    </div>
    
    <div class="terminal-wrapper" id="terminal_wrapper">
      <div class="terminal p-3" id="terminal"></div>
    </div>
    
    <div id="input-container" class="d-flex align-items-center mb-3">
      <span id="current-dir"></span>
      <input type="text" id="input" class="form-control" autofocus placeholder="Type command here...">
    </div>
  

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script module>
    const terminal = document.getElementById('terminal');
    const input = document.getElementById('input');
    const currentDirDisplay = document.getElementById('current-dir');
    let currentDir = '';
    let suggestions = [];
    const suggestionsContainer = document.getElementById('suggestions-container');

    function fetchCurrentDirectory() {
      fetch('http://127.0.0.1:3030/get_current_dir')
        .then(response => response.json())
        .then(data => {
          currentDir = data.current_dir;
          currentDirDisplay.textContent = `${currentDir}> `;
        })
        .catch(err => {
          console.error('Error fetching current directory:', err);
        });
    }

    function createCommandBlock(command, output, isError = false) {
      const block = document.createElement('div');
      block.className = 'command-block mb-3';

      const commandElement = document.createElement('div');
      commandElement.className = 'command p-2';
      commandElement.textContent = `${currentDir}> ${command}`;
      block.appendChild(commandElement);

      const outputElement = document.createElement('div');
      outputElement.className = isError ? 'error p-2' : 'output p-2';
      outputElement.textContent = output;
      block.appendChild(outputElement);

      return block;
    }
    
    function checkObfuscation(command) {
        return fetch('http://127.0.0.1:5000/classify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ commands: [command] })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            return response.json();
        })
        .then(result => {
            return result.classifications[0] === 1; 
        })
        .catch(err => {
            console.error('Obfuscation Detection Error:', err);
            terminal.innerHTML += `<div style="color:red;">Obfuscation Detection Error: ${err.message}</div>`;
            return false;
        });
    }
        function checkRiskyCom(command) {
      return fetch('http://127.0.0.1:4000/risk_classify', {  // URL của API kiểm tra command
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ command: command })  // Gửi command dưới dạng JSON
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok.');
          }
          return response.json();
      })
      .then(result => {
          // Giả sử API trả về {"classification": "Risky"} hoặc {"classification": "Non-Risky"}
          return result.classification === 'Risky';  // Trả về true nếu lệnh là "Risky"
      })
      .catch(err => {
          console.error('Risky Command Detection Error:', err);
          terminal.innerHTML += `<div style="color:red;">Risky Command Detection Error: ${err.message}</div>`;
          return false;  // Trả về false nếu có lỗi
      });
    }
   // Send command to FastAPI auto endpoint
     function sendToAutoAPI(command) {
        fetch('http://127.0.0.1:8000/auto/', {  // Replace with your actual API endpoint
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: command })
        })
        .then(response => response.json())
        .then(result => {
            if (result.answer) {
                terminal.innerHTML += `<div style="color:blue;">${result.answer}</div>`;
            } else {
                terminal.innerHTML += `<div style="color:red;">No suggestion available</div>`;
            }
            terminal.scrollTop = terminal.scrollHeight; // Auto-scroll to the bottom
        })
        .catch(err => {
            terminal.innerHTML += `<div style="color:red;">Auto Suggest Error: ${err}</div>`;
        });
    }
  // Create the content for the popup
function createPopup() {
  // Create a new window
  const popupWindow = window.open('', 'Night Owl Popup', 'width=300,height=200');

  // Create the content for the popup
  const popupContent = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Night Owl Popup</title>
      <style>
        body {
          font-family: 'Consolas', 'Courier New', monospace;
          padding: 20px;
          background-color: #011627;
          color: #d6deeb;
        }
        .block {
          margin-bottom: 20px;
        }
        .text-box {
          width: 100%;
          padding: 10px;
          background-color: #01121f;
          border: 1px solid #1d3b53;
          color: #d6deeb;
          font-family: inherit;
          font-size: 14px;
          resize: vertical;
        }
        .text-box::placeholder {
          color: #4b6479;
        }
        .result {
          background-color: #01121f;
          border: 1px solid #1d3b53;
          padding: 10px;
        }
        .result strong {
          color: #c792ea;
        }
        .result span {
          color: #addb67;
        }
      </style>
    </head>
    <body>
      <div class="block">
        <textarea class="text-box" id="inputText" rows="3" placeholder="Enter text here"></textarea>
      </div>
      <div class="block">
        <div class="result">
          <strong>Result:</strong> <span id="resultText">meow</span>
        </div>
      </div>
    </body>
    </html>
  `;

  // Write the content to the popup window
  popupWindow.document.write(popupContent);
  popupWindow.document.close();

  // Add the script to the popup window
  const script = popupWindow.document.createElement('script');
  script.textContent = `
    function callApi() {
      const inputText = document.getElementById('inputText').value;

      // Example API call using Fetch (replace with your API URL and handling)
      fetch('http://127.0.0.1:8000/agent/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ question: inputText }),
      })
        .then(response => response.json())
        .then(data => {
          document.getElementById('resultText').textContent = data.answer || 'No result found';
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          document.getElementById('resultText').textContent = 'Error fetching data';
        });
    }

    document.getElementById('inputText').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        callApi();
      }
    });
  `;
  popupWindow.document.body.appendChild(script);
}

    document.addEventListener('DOMContentLoaded', fetchCurrentDirectory);
      input.addEventListener('keydown', async function(event) {
      const command = input.value;
      if (event.key === 'Enter') {
        let run_flag = true;
        const isObfuscated = await checkObfuscation(command);
        if (isObfuscated) {
          const result = await confirm('This command is obfuscated, which means it is potentially risky. Are you sure to execute the command ?');
          if (!result) { // yes
            run_flag = false;
            input.value = '';
          }
        }
        if (run_flag) {
          fetch('http://127.0.0.1:3030/run_command', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ input: command }),
          })
          .then(response => response.json())
          .then(result => {
            const block = createCommandBlock(command, result.output || result.error, !!result.error);
            terminal.appendChild(block);
            terminal.scrollTop = terminal.scrollHeight;
            fetchCurrentDirectory();
          })
          .catch(err => {
            const block = createCommandBlock(command, `Error: ${err}`, true);
            terminal.appendChild(block);
            terminal.scrollTop = terminal.scrollHeight;
          });

          input.value = '';
        }
      } else if (event.key === 'Tab') {

        if (command.trim().startsWith('#')) {
          terminal.innerHTML += `<div style="color:red;">meow</div>`;
          /// vao duo
          
          block = createPopup();

          terminal.innerHTML += `<div style="color:red;">meow</div>`;

          
        }
        }
      }
    );

  </script>
  <script>
    document
      .getElementById('education')
      .addEventListener('click',  async () => { try { await window.__TAURI__.invoke('run_trivia_game'); console.log('Trivia game started successfully!'); } catch (error) { console.error('Failed to start the trivia game:', error); } });

    document
      .getElementById('titlebar-minimize')
      .addEventListener('click', () => window.__TAURI__.window.appWindow.minimize())
    document
      .getElementById('titlebar-maximize')
      .addEventListener('click', () => window.__TAURI__.window.appWindow.maximize())
    document
      .getElementById('titlebar-close')
      .addEventListener('click', () => window.__TAURI__.window.appWindow.close())
  </script>

</body>
</html>